{{ define "organization_list" }}
{{ template "_header" .}}



<div class="jumbotron jumbotron-fluid">
    <div class="container">
        <!-- Example row of columns -->
        <div class="row">


            <div class="col-md-12 col-sm-12 col-xs-12">
                <div class="x_panel">
                    <div class="x_title">
                        <h2>Organization <small>{{ .Organization.Name }}</small></h2>

                        <div class="clearfix"></div>
                    </div>


                    <div class="x_content">

                        <p>Add class <code>bulk_action</code> to table for bulk actions options on row select</p>

                        <div class="table-responsive">
                            <table class="table table-striped jambo_table bulk_action">
                                <thead>
                                <tr class="headings">
                                    <th>
                                        <input type="checkbox" id="check-all" class="flat">
                                    </th>
                                    <th class="column-title">Id</th>
                                    <th class="column-title">Name</th>
                                    <th class="column-title">Type</th>
                                    <th class="column-title">Github Repository</th>
                                    <th class="column-title">Gitlab Repository</th>
                                    <th class="column-title no-link last"><span class="nobr">Actions</span>
                                    </th>

                                </tr>
                                </thead>

                                <tbody>
                                {{ range .Projects }}
                                <tr class="even pointer table-color-{{ .Type }}">
                                    <td class="a-center ">
                                        <input type="checkbox" class="flat" name="table_records">
                                    </td>
                                    <td>{{ .Id }}</td>
                                    <td>{{ .Name }}<div><span class="badge badge-primary">{{ .LocalPath}}</span></div></td>
                                    <td>{{ .Type }}</td>
                                    <td><span class="badge badge-dark">{{ .GithubLastCommitAuthor }}</span> <span class="badge badge-primary">{{ .GithubLastCommitName }}</span>
                                        {{ .GithubLastCommitTime | timeAgo }}

                                        {{ if .NewCommitName }}
                                        <br><span class="badge badge-warning">{{ .NewCommitName}}</span> {{ .NewCommitDate | timeAgo }}
                                        {{ end }}
                                        <br>
                                        <span class="badge badge-secondary">{{ .GithubReleaseTag }}</span>
                                        {{ if .NewTag }}
                                        ->
                                        <span class="badge badge-success">{{ .NewTag }}</span>
                                        {{ end }}
                                    </td>
                                    <td><span class="badge badge-dark">{{ .GitlabLastCommitAuthor }}</span> <span class="badge badge-primary">{{ .GitlabLastCommitName }}</span>
                                        {{ .GitlabLastCommitTime | timeAgo }}

<!--                                        {{ if .NewCommitName }}-->
<!--                                        <br><span class="badge badge-warning">{{ .NewCommitName}}</span> {{ .NewCommitDate | timeAgo }}-->
<!--                                        {{ end }}-->
                                        <br>
                                        <span class="badge badge-secondary">{{ .GitlabReleaseTag }}</span>
<!--                                        {{ if .NewTag }}-->
<!--                                        ->-->
<!--                                        <span class="badge badge-success">{{ .NewTag }}</span>-->
<!--                                        {{ end }}-->
                                    </td>

                                    <td class=" last">

                                        {{ if eq .Type 1 }}
                                            <div class="btn btn-primary loadData" data-type="entity" data-project-id="{{ .Id }}" title="entity">E</div>
                                            <div class="btn btn-primary loadData" data-type="migration" data-project-id="{{ .Id }}"  title="Migration">M</div>
                                            <div class="btn btn-primary loadData" data-type="service" data-project-id="{{ .Id }}" title="Service">S</div>
                                            <div class="btn btn-primary loadData" data-type="test" data-project-id="{{ .Id }}" title="Test File">T</div>
                                            <div class="btn btn-primary loadData" data-type="general" data-project-id="{{ .Id }}" title="General File">G</div>
                                            <div class="btn btn-warning loadData" data-type="all" data-project-id="{{ .Id }}" title="General File">All</div>
                                        {{ end }}
                                    </td>

                                </tr>
                                <tr><td colspan="100%"><div class="data-projectid data-projectid-{{ .Id }}"></div></td></tr>
                                {{ end }}
                                </tbody>
                            </table>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>



<!-- Modal -->
<div class="modal fade bd-example-modal-xl" id="compareModal" tabindex="-1" role="dialog" aria-labelledby="compareModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="compareModalLabel">Code Comparison</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div id="container" style="height: 800px;"></div>
            </div>
        </div>
    </div>
</div>

ß

<script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.20.0/min/vs/loader.min.js"></script>
<script>

        function fetchData(projectId, parts) {

            $('.data-projectid').html("");

            parts.forEach((part) => {
                $.ajax({
                    url: '/api/generate-' + part,
                    type: 'GET',
                    dataType: 'json',
                    data: {
                        project_id: projectId
                    },
                    success: function (response) {
                        const filesPreviews = response;

                        let content = filesPreviews.map(filesPreview => {
                            var hash = Math.random().toString(36).substring(7);
                            var label = '';

                            if (!filesPreview.has_file) {
                                label = `<span class="badge badge-success">New</span>`
                            }
                            if (filesPreview.has_file && !filesPreview.has_diff) {
                                label = `<span class="badge badge-secondary">same</span>`
                            }
                            if (filesPreview.has_file && filesPreview.has_diff) {
                                label = `<span class="badge badge-warning">diff</span>`
                            }

                            return `
                            <tr class="file-preview">
                                <td><input type="checkbox"  class="file-checkbox"></td>
                                <td class="file-path">${label} <span class="file-path-only">${filesPreview.file_path}</span></td>
                                <td>${filesPreview.has_file}</td>
                                <td>${filesPreview.has_diff}</td>
                                <td>
                                             <div style="display: none" class="codeleft ${projectId}-${hash}-left">${filesPreview.old_code}</div>
                                            <div style="display: none" class="coderight ${projectId}-${hash}-right">${filesPreview.new_code}</div>
                                            <button class="btn btn-primary btn-sm compare-btn" data-toggle="modal" data-target="#compareModal" data-code="${projectId}-${hash}">Compare Code 1</button>
                                </td>
                            </tr>
                        `;
                        }).join('');


                        content = `<div class="${part}">
                                <h2>Generate ${part} files</h2>
                                <div class="table-responsive-lg">
                                  <table class="table list-files">
                                        <tr class="file-preview">
                                            <td><input type="checkbox"></td>
                                            <td>File Path </td>
                                            <td>Has File</td>
                                            <td>Has Diff</td>
                                            <td>Actions</td>
                                        </tr>
                                     ${content}
                                  </table>
                                </div>
                                </div>

                                 <button class="btn btn-success btn-sm save-files">Save ALL checked</button>
                            `;

                        $('.data-projectid-' + projectId).html($('.data-projectid-' + projectId).html()+content);
                        $('.table.list-files',document).each(function () {
                            const $table = $(this);
                            const $firstCheckbox = $table.find('tr.file-preview:first-child input[type="checkbox"]');
                            const $allCheckboxes = $table.find('tr.file-preview input[type="checkbox"]');

                            $firstCheckbox.on('change', function () {
                                const isChecked = $(this).prop('checked');
                                $allCheckboxes.prop('checked', isChecked);
                            });
                        });
                    },
                    error: function (jqXHR, textStatus, errorThrown) {
                        console.error("Error: " + textStatus + "; " + errorThrown);
                    }
                });
            });
    }

        $(document).ready(function() {
        $('.loadData').on('click', function() {
            let type = [$(this).data("type")]
            const projectId = $(this).data('project-id');

            if ($(this).data("type") == 'all') {
                type = ['entity','migration','service','test','general'];
            }

            fetchData(projectId,type);
        });
    });


    document.addEventListener('DOMContentLoaded', function () {


        let compareEditor;
        let codeLeft;
        let codeRight;

        const initCompareEditor = (leftCode, rightCode) => {
            if (compareEditor) {
                compareEditor.dispose();
                compareEditor = null;
            }

            require.config({ paths: { vs: 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.20.0/min/vs' } });
            require(['vs/editor/editor.main'], function () {
                compareEditor = monaco.editor.createDiffEditor(document.getElementById('container'), {
                    originalEditable: true,
                    readOnly: false,
                    language: 'go',
                });

                compareEditor.setModel({
                    original: monaco.editor.createModel(leftCode, 'go'),
                    modified: monaco.editor.createModel(rightCode, 'go'),
                });
            });
        };



        // Открытие модального окна
        $(document).on('click','.compare-btn', function () {
            var classblock = $(this).data("code");
            console.log(classblock)
            codeLeft =$("."+classblock+"-left",document).html()
            codeRight =$("."+classblock+"-right",document).html()
        });

        // Открытие модального окна
        $('#compareModal').on('shown.bs.modal', function () {
            initCompareEditor(codeLeft, codeRight);
        });


        // Закрытие модального окна
        $('#compareModal').on('hidden.bs.modal', function () {
            if (compareEditor) {
                compareEditor.dispose();
                compareEditor = null;
            }
        });
    });

        async function sendFilesToServer(files) {
            files = files || collectFilesData();
            for (const file of files) {
                const formData = new FormData();
                formData.append("filepath", file.filepath);
                formData.append("code", file.code);

                const response = await fetch("/api/save-file", {
                    method: "POST",
                    body: formData,
                });

                if (response.ok) {
                    console.log(`File ${file.filepath} successfully saved`);
                } else {
                    console.log(`Error while saving file ${file.filepath}`);
                }
            }
            console.log("All files processed");
        }



        function collectFilesData() {
            const files = [];

            $('.file-preview').each(function() {
                const isChecked = $(this).find('.file-checkbox').prop('checked');
                if (!isChecked) return;

                const filePath = $(this).find('.file-path-only').text();
                const code = $(this).find('.coderight').text();

                files.push({
                    filepath: filePath,
                    code: code,
                });
            });

            return files;
        }

        $(document).on('click','.save-files', function () {
            sendFilesToServer();
        });


</script>

{{ template "_footer" .}}
{{ end }}
